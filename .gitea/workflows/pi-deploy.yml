name: Deploy to Raspberry Pi
run-name: ${{ gitea.actor }} is deploying to /home/ieee/SEC26 ðŸ¤–

on:
  push:
    branches:
      - prod
      - CD-testing
  workflow_dispatch:

jobs:
  deploy-robot:
    runs-on: rpi-ros2

    # Force all steps to run inside your specific directory
    defaults:
      run:
        working-directory: /home/ieee/SEC26

    steps:
      - name: ðŸŒ Check internet connectivity
        run: |
          echo "Checking internet connectivity..."
          if curl --max-time 5 -sf https://gitea.syndric.org/api/v1/version >/dev/null 2>&1; then
            echo "âœ… Gitea reachable"
          else
            echo "âŒ No internet connectivity â€” aborting deployment"
            exit 1
          fi

      - name: ðŸ’¡ Clear LEDs and start deploy indicator
        run: |
          echo "ðŸ’¡ Clearing RGB LEDs and starting GPIO deploy indicator"
          # Clear the 5 RGB LEDs via ROS2 (if container is running)
          docker compose -f docker-compose.yml --project-directory . exec -T devcontainer \
            bash -c "source /opt/ros/jazzy/setup.bash && ros2 topic pub --once /mcu_robot/led/set_all mcu_msgs/msg/LedColor '{r: 0, g: 0, b: 0}'" 2>/dev/null || true
          # Flash GPIO boot LED during deployment
          sudo systemctl stop sec26-bootled 2>/dev/null || true
          sudo systemd-run --unit=sec26-bootled \
            bash -c 'while true; do gpioset -c gpiochip0 17=1; sleep 0.2; gpioset -c gpiochip0 17=0; sleep 0.2; done'

      - name: ðŸ“‚ Pull Latest Code (Robot)
        run: |
          echo "ðŸ“‚ Navigating to /home/ieee/SEC26..."
          git config --global --add safe.directory /home/ieee/SEC26

          # Save current HEAD before updating so we can diff against it later
          PREV_SHA=$(git rev-parse HEAD 2>/dev/null || echo "")
          echo "$PREV_SHA" > /tmp/deploy_prev_sha

          git fetch --all
          echo "ðŸ”€ Switching to branch: ${{ gitea.ref_name }}"
          git reset --hard origin/${{ gitea.ref_name }}
          echo "ðŸ“‚ Updating submodules..."
          git submodule update --init --recursive
          echo "ðŸ”§ Fixing permissions..."
          chmod +x scripts/start_robot.sh

          NEW_SHA=$(git rev-parse HEAD)
          echo "ðŸ“Š Deploy diff: ${PREV_SHA:0:8}..${NEW_SHA:0:8}"
          if [ -n "$PREV_SHA" ] && [ "$PREV_SHA" != "$NEW_SHA" ]; then
            echo "Changed files:"
            git diff --name-only "$PREV_SHA" "$NEW_SHA" | head -50
          fi

      - name: ðŸ”¨ Build MCU firmware (inside Docker)
        run: |
          echo "ðŸ”¨ Building MCU firmware via Docker..."
          PREV_SHA=$(cat /tmp/deploy_prev_sha 2>/dev/null || echo "")

          # Clean micro-ROS libs if mcu_msgs or microros config changed
          if [ -n "$PREV_SHA" ] && git diff --name-only "$PREV_SHA" HEAD 2>/dev/null | grep -qE "mcu_msgs/|custom_microros\.meta|libs_external/"; then
            echo "ðŸ“¦ mcu_msgs or microros config changed â€” cleaning micro-ROS libraries"
            docker compose -f docker-compose.yml --project-directory . exec -T devcontainer \
              bash -c "cd /home/ubuntu/mcu_workspaces/sec26mcu && pio run -e robot -t clean_microros" || true
          fi

          docker compose -f docker-compose.yml --project-directory . exec -T devcontainer \
            bash -c "cd /home/ubuntu/mcu_workspaces/sec26mcu && pio run" || {
            echo "âš ï¸ Docker exec failed â€” container may not be running, will build after restart"
          }

      - name: ðŸš€ Build and Deploy (Docker)
        run: |
          echo "ðŸš€ Rebuilding from: /home/ieee/SEC26/docker-compose.yml"
          COMPOSE_FILE="docker-compose.yml"

          # Check if Dockerfile/docker-compose changed since last deploy
          PREV_SHA=$(cat /tmp/deploy_prev_sha 2>/dev/null || echo "")
          if [ -n "$PREV_SHA" ] && git diff "$PREV_SHA" HEAD --name-only 2>/dev/null | grep -q "Dockerfile\|docker-compose"; then
            echo "ðŸ“ Dockerfile or docker-compose changed; full down/rebuild/up cycle"
            docker compose -f $COMPOSE_FILE --project-directory . down || true
          else
            echo "ðŸ“ No Dockerfile/docker-compose changes; only stopping and restarting"
            docker compose -f $COMPOSE_FILE --project-directory . stop || true
          fi

          # Rebuild the image
          docker compose -f $COMPOSE_FILE --project-directory . build

          # Start the container
          docker compose -f $COMPOSE_FILE --project-directory . up -d

      - name: â–¶ï¸ Trigger deploy orchestrator
        run: |
          # Wait for container to stabilize
          sleep 5

          # Write trigger file for the deploy orchestrator
          mkdir -p scripts/.deploy
          cat > scripts/.deploy/trigger << TRIGGER
          target=robot
          branch=${{ gitea.ref_name }}
          online=true
          timestamp=$(date +%s)
          TRIGGER
          # Clean up whitespace from heredoc indentation
          sed -i 's/^[[:space:]]*//' scripts/.deploy/trigger

          echo "Trigger file written, waiting for orchestrator to complete..."

          # Poll status file for completion (timeout after 15 minutes)
          TIMEOUT=900
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if [ -f scripts/.deploy/status ]; then
              PHASE=$(grep '^phase=' scripts/.deploy/status | cut -d= -f2)
              MSG=$(grep '^message=' scripts/.deploy/status | cut -d= -f2)
              echo "Phase: $PHASE â€” $MSG"
              if [ "$PHASE" = "done" ]; then
                echo "Deployment completed successfully!"
                exit 0
              elif [ "$PHASE" = "failed" ]; then
                echo "Deployment failed: $MSG"
                exit 1
              fi
            fi
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          echo "Deployment timed out after ${TIMEOUT}s"
          exit 1

      - name: ðŸ§¹ Cleanup
        run: |
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f

      - name: âš¡ Ensure LED process stops (always)
        if: ${{ always() }}
        run: |
          echo "âš¡ Ensuring BOOTLED process is stopped regardless of job outcome"
          sudo systemctl stop sec26-bootled 2>/dev/null || true
          gpioset -c gpiochip0 17=1 || true

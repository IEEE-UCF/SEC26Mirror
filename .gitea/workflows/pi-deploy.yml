name: Deploy to Raspberry Pi
run-name: ${{ gitea.actor }} is deploying to /home/ieee/SEC26 ğŸ¤–

on:
  push:
    branches:
      - prod
      - CD-testing
  workflow_dispatch:

jobs:
  # 1. Robot Job - Always Runs
  deploy-robot:
    runs-on: rpi-ros2
    
    # Force all steps to run inside your specific directory
    defaults:
      run:
        working-directory: /home/ieee/SEC26

    steps:
      - name: ğŸ“‚ Pull Latest Code (Robot)
        run: |
          echo "ğŸ“‚ Navigating to /home/ieee/SEC26..."
          git config --global --add safe.directory /home/ieee/SEC26
          git fetch --all
          echo "ğŸ”€ Switching to branch: ${{ gitea.ref_name }}"
          git reset --hard origin/${{ gitea.ref_name }}
          echo "ğŸ”§ Fixing permissions..."
          chmod +x scripts/start_robot.sh

      - name: ğŸ§ª Run Verification Script
        run: |
          echo "ğŸ§ª Running test script on the Pi..."
          # The verification script runs from the working-directory/scripts
          python3 scripts/test_deploy.py

      - name: ğŸš€ Build and Deploy (Docker)
        run: |
          echo "ğŸš€ Rebuilding from: /home/ieee/SEC26/docker-compose.yml"
          COMPOSE_FILE="docker-compose.yml"
          
          # 1. Stop existing services
          docker compose -f $COMPOSE_FILE --project-directory . down || true
          
          # 2. Rebuild the image
          docker compose -f $COMPOSE_FILE --project-directory . build
          
          # 3. Start the container
          docker compose -f $COMPOSE_FILE --project-directory . up -d

      - name: â–¶ï¸ Run and activate ROS2 things
        run: |
          # 4. Wait a moment for container to stabilize
          sleep 5

          # 5. Flash MCU firmware from docker container
          docker exec -u ubuntu sec26-devcontainer-1 bash -c "cd /home/ubuntu/scripts && chmod +x flash_mcu.sh && ./flash_mcu.sh"
          
          # 6. Run the script INSIDE the container
          docker exec -u ubuntu sec26-devcontainer-1 bash -c "cd /home/ubuntu/scripts && chmod +x start_robot.sh && ./start_robot.sh"

      - name: ğŸ§¹ Cleanup
        run: |
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f
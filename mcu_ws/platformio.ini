[platformio]
default_envs =
    robot
    drone
    minibot
    beacon1
    beacon2
    beacon3
    teensy-test-all-subsystems

; 1. DEFINITIONS AND SHARED VARIABLES
[common]
build_flags = -std=gnu++17
build_unflags = -std=gnu++11

; Core library used by most environments
lib_core =
    https://github.com/IEEE-UCF/SEC-Base-Classes.git#a5f8c9f
    pfeerick/elapsedMillis@^1.0.6

; Full library set for robot and Teensy-based environments
lib_robot =
    ${common.lib_core}
    adafruit/Adafruit INA219@^1.2.3
    adafruit/Adafruit BusIO@^1.17.4
    https://github.com/adafruit/Adafruit-PWM-Servo-Driver-Library.git
    https://github.com/adafruit/Adafruit_BNO08x.git
    https://github.com/adafruit/Adafruit_VL53L0X.git
    https://github.com/pololu/vl53l0x-arduino.git
    https://github.com/RobTillaart/TCA9548.git
    https://github.com/bmellink/IBusBM.git
    https://github.com/IEEE-UCF/DW3000_Arduino.git
    adafruit/Adafruit GFX Library@^1.11.9
    adafruit/Adafruit SSD1306@^2.5.9
    adafruit/Adafruit MPU6050 @ ^2.2.9

; 2. GLOBAL SETTINGS (Applies to all [env:***])
[env]
monitor_speed = 921600

; 2.1 micro-ROS shared configuration
[microros_base]
; Align micro-ROS distro with your ROS agent
board_microros_distro = jazzy
; Default to serial transport for tests and simple setups
board_microros_transport = serial
; Override default entity limits
board_microros_user_meta = custom_microros.meta

; 3. HARDWARE BASE CONFIGURATIONS (Not buildable targets)

[esp32_base]
platform = espressif32
board = esp32dev
framework = arduino
build_flags = ${common.build_flags}
build_unflags = ${common.build_unflags}
lib_deps =
    ${common.lib_core}

[teensy_base]
platform = teensy
board = teensy41
framework = arduino
upload_protocol = teensy-cli
; Custom linker script that discards exception handling sections to fix
; ARM R_ARM_PREL31 relocation errors in large firmware images
board_build.ldscript = linker/imxrt1062_t41_noexcept.ld
build_flags =
    -Wformat=1
    -DUSB_SERIAL
    -DTEENSY_OPT_FASTER
    -DUSE_ARDUINO_DEFINES
    -DUSE_TEENSYTHREADS
    ; Disable exceptions and RTTI completely
    -fno-exceptions
    -fno-rtti
    -fno-unwind-tables
    -fno-asynchronous-unwind-tables
build_unflags = -fexceptions -frtti
upload_flags = -v
lib_deps =
    ${common.lib_core}
    https://github.com/IEEE-UCF/TeensyThreads.git
    fastled/FastLED@^3.9.12

[esp32_microros_wifi]
extends = esp32_base
board_microros_distro = jazzy
board_microros_transport = wifi
lib_extra_dirs = libs_external/esp32
; Shared network settings â€” override WIFI_SSID/WIFI_PASSWORD/AGENT_IP as needed
; Per-device LOCAL_IP and LOCAL_MAC must be set in each concrete environment
build_flags =
    ${esp32_base.build_flags}
    -DMICRO_ROS_TRANSPORT_ARDUINO_WIFI
    '-DAGENT_IP={ 192, 168, 4, 1 }'
    '-DAGENT_PORT=8888'
    '-DWIFI_SSID="UCFIEEEBot"'
    '-DWIFI_PASSWORD="goodlife"'

[teensy_microros]
extends = teensy_base, microros_base
build_flags =
    -DMICRO_ROS_TRANSPORT_ARDUINO_SERIAL
    ${teensy_base.build_flags}
lib_extra_dirs = libs_external/teensy
lib_deps =
    ${common.lib_robot}
    https://github.com/IEEE-UCF/TeensyThreads.git
    fastled/FastLED@^3.9.12

; ============================================================
; 4. CONCRETE ENVIRONMENTS (The actual targets)
; ============================================================

; --- Field Elements (ESP32) ---
; We simply extend the esp32_base and specify the filter

[env:field-button]
extends = esp32_base
build_src_filter = +<field/field-button.cpp> +<field/button.cpp>
lib_deps =
    ${common.lib_core}
    arduinogetstarted/ezButton@^1.0.0

[env:field-controller]
extends = esp32_base
build_src_filter = +<field/field-controller.cpp> +<field/controller.cpp>
lib_deps =
    ${common.lib_core}
    marcoschwartz/LiquidCrystal_I2C@^1.1.4

[env:field-crank]
extends = esp32_base
build_src_filter = +<field/field-crank.cpp> +<field/crank.cpp>

[env:field-earth]
extends = esp32_base
build_src_filter = +<field/field-earth.cpp> +<field/earth.cpp>
lib_deps =
    ${common.lib_core}
    Arduino-IRremote/IRremote@^4.4.1

[env:field-keypad]
extends = esp32_base
build_src_filter = +<field/field-keypad.cpp> +<field/keypad.cpp>

[env:field-pressure]
extends = esp32_base
build_src_filter = +<field/field-pressure.cpp> +<field/pressure.cpp>

; --- Robot Elements ---

[env:robot]
extends = teensy_microros
build_src_filter = +<robot>, +<platform/atomic_stubs_arm.c>

[env:drone]
extends = esp32_microros_wifi
build_src_filter = +<drone>
lib_deps =
    ${common.lib_core}
    adafruit/Adafruit BusIO@^1.17.4
    https://github.com/adafruit/Adafruit_BNO08x.git
    https://github.com/pololu/vl53l1x-arduino.git
    Arduino-IRremote/IRremote@^4.4.1
build_flags =
    ${esp32_microros_wifi.build_flags}
    '-DLOCAL_IP={ 192, 168, 4, 25 }'
    '-DLOCAL_MAC={ 0xDE, 0xAD, 0xBE, 0xEF, 0x05, 0x25 }'

[env:minibot]
extends = esp32_microros_wifi
build_src_filter = +<minibot>
lib_deps =
    ${common.lib_core}
    https://github.com/IEEE-UCF/DW3000_Arduino.git
build_flags =
    ${esp32_microros_wifi.build_flags}
    '-DLOCAL_MAC={ 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x14 }'
    '-DLOCAL_IP={ 192, 168, 4, 24 }'

; --- UWB Beacons (WiFi micro-ROS) ---
; ID reservation: 10-12 = beacons, 13 = robot, 14 = minibot, 15 = drone
; Lower-ID beacon initiates inter-beacon ranging to higher-ID peers.
; Adjust LOCAL_IP and LOCAL_MAC per device as needed.

[env:beacon1]
extends = esp32_microros_wifi
build_src_filter = +<beacon>
lib_deps =
    ${common.lib_core}
    https://github.com/IEEE-UCF/DW3000_Arduino.git
build_flags =
    ${esp32_microros_wifi.build_flags}
    -D BEACON_ID=10
    '-DLOCAL_MAC={ 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x10 }'
    '-DLOCAL_IP={ 192, 168, 4, 20 }'

[env:beacon2]
extends = esp32_microros_wifi
build_src_filter = +<beacon>
lib_deps =
    ${common.lib_core}
    https://github.com/IEEE-UCF/DW3000_Arduino.git
build_flags =
    ${esp32_microros_wifi.build_flags}
    -D BEACON_ID=11
    '-DLOCAL_MAC={ 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x11 }'
    '-DLOCAL_IP={ 192, 168, 4, 21 }'

[env:beacon3]
extends = esp32_microros_wifi
build_src_filter = +<beacon>
lib_deps =
    ${common.lib_core}
    https://github.com/IEEE-UCF/DW3000_Arduino.git
build_flags =
    ${esp32_microros_wifi.build_flags}
    -D BEACON_ID=12
    '-DLOCAL_MAC={ 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0x12 }'
    '-DLOCAL_IP={ 192, 168, 4, 22 }'

; --- Tests ---
[env:teensy-test-battery-subsystem]
extends = teensy_microros
build_src_filter = +<test/teensy-test-battery-subsystem.cpp>, +<robot/subsystems/BatterySubsystem.cpp>, +<platform/atomic_stubs_arm.c>

[env:teensy-test-sensor-subsystem]
extends = teensy_microros
build_src_filter = +<test/teensy-test-sensor-subsystem.cpp>, +<robot/subsystems/SensorSubsystem.cpp>, +<platform/atomic_stubs_arm.c>

[env:teensy-test-oled-subsystem]
extends = teensy_microros
build_src_filter =
    +<test/teensy-test-oled-subsystem.cpp>
    +<robot/subsystems/BatterySubsystem.cpp>
    +<robot/subsystems/ImuSubsystem.cpp>
    +<robot/subsystems/OLEDSubsystem.cpp>
    +<robot/subsystems/RCSubsystem.cpp>
    +<robot/subsystems/SensorSubsystem.cpp>
    +<platform/atomic_stubs_arm.c>
    +<platform/exception_stubs_arm.c>

[env:esp32-test-microros-wifi]
extends = esp32_microros_wifi
build_src_filter = +<test/esp32-test-microros-wifi.cpp>
build_flags =
    ${esp32_microros_wifi.build_flags}
    '-DLOCAL_MAC={ 0xAA, 0xBB, 0xCC, 0xEE, 0xDD, 0xFF }'
    '-DLOCAL_IP={ 192, 168, 4, 100 }'

[env:teensy-test-all-subsystems]
extends = teensy_microros
build_src_filter =
    +<test/teensy-test-all-subsystems.cpp>
    +<robot/subsystems/BatterySubsystem.cpp>
    +<robot/subsystems/ImuSubsystem.cpp>
    +<robot/subsystems/OLEDSubsystem.cpp>
    +<robot/subsystems/RCSubsystem.cpp>
    +<robot/subsystems/SensorSubsystem.cpp>
    +<platform/atomic_stubs_arm.c>
    +<platform/exception_stubs_arm.c>

[env:teensy-test-rc-subsystem]
extends = teensy_microros
build_src_filter =
    +<test/teensy-test-rc-subsystem.cpp>
    +<robot/subsystems/RCSubsystem.cpp>
    +<platform/atomic_stubs_arm.c>

[env:teensy-test-arm-servos]
extends = teensy_microros
build_src_filter =
    +<test/teensy-test-arm-servos.cpp>
    +<platform/atomic_stubs_arm.c>

[env:teensy-test-drive-motors]
extends = teensy_microros
build_src_filter =
    +<test/teensy-test-drive-motors.cpp>
    +<platform/atomic_stubs_arm.c>

[env:esp32-test-simple-wifi]
extends = esp32_base
build_src_filter = +<test/esp32-test-simple-wifi.cpp>

[native_test_base]
platform = native
build_flags = -std=gnu++17
lib_deps =
lib_ignore =
    field
    ir
    sensors
    robot
    subsystems
    microros

[env:test-math-pose2d]
extends = native_test_base
test_filter = test_math_pose2d

[env:test-math-vector2d]
extends = native_test_base
test_filter = test_math_vector2d

[env:test-math-pose3d]
extends = native_test_base
test_filter = test_math_pose3d

[env:test-control-pid]
extends = native_test_base
test_filter = test_control_pid

[env:test-control-arm-kinematics]
extends = native_test_base
test_filter = test_control_arm_kinematics

[env:test-control-trapezoidal-motion-profile]
extends = native_test_base
test_filter = test_control_trapezoidal_motion_profile

[env:test-control-scurve-motion-profile]
extends = native_test_base
test_filter = test_control_scurve_motion_profile

[env:test-control-trajectory-controller]
extends = native_test_base
test_filter = test_control_trajectory_controller

[env:test-utils-filters]
extends = native_test_base
test_filter = test_utils_filters

[env:test-utils-units]
extends = native_test_base
test_filter = test_utils_units

[env:test-drive-tankdrivelocalization]
extends = native_test_base
test_filter = test_drive_tankdrivelocalization